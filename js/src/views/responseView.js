



(function() {
    "use strict";

    var responseMap = require('../data/responseMap.json');

    var ResponseView = Backbone.View.extend({
        el: '#response',
        events: {
            'click a#printversion': 'print'
        },

        initialize: function() {
            //this.scene = scenesManager.createScene('response', ResponseScene);

            this.$background = $('#response-bg');

        },
        
        setResponse: function(models) {
            var nameModel = models[0];
            var characterModel = models[1];

            this.$background.addClass(characterModel.attributes.value);

            var answeredQuestions = _.filter(_.rest(models, 2), function(model) {return model.attributes.value !== ''});

            var partitionedQuestions = _.partition(answeredQuestions, function(model) {
                return model.attributes.class !== 'canned';
            });

            var personalityModels = partitionedQuestions[0];
            var cannedModels = partitionedQuestions[1];


            var character = characterModel.attributes.value;
            var response = "";

            // ******** sort here ********

            var personalityResponses = _.map(personalityModels, function(model)  {
                return responseMap[character][model.attributes.name].replace('%template%', model.attributes.text);
            });

            var cannedResponses = _.map(cannedModels, function(model) {
                return responseMap[character][model.attributes.value];
            });

            response += ' ' + cannedResponses.join(' ') + ' ' + personalityResponses.join(' ');

            $('#card-header').find('span').html(nameModel.attributes.value);
            $('#card-sincerely').find('span').html(nameModel.attributes.value);
            $('#card-body').html(response);
            $('#card-from').html(character);
        },

        show: function() {
            this.$el.show();
            this.$background.show();
            //scenesManager.goToScene('response');
        },
        hide: function() {

        },
        
        print: function(){
          window.print();
        }


    });













    module.exports = ResponseView;
})();